<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eliminador de Fondos (Framework V2 Fix - Completo) - XocoStudio</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- === FRAMEWORK: img-comparison-slider === -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/img-comparison-slider@8/dist/index.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/img-comparison-slider@8/dist/style.css" />
    <!-- === FIN FRAMEWORK === -->

    <style>
        /* Estilos CSS de tu versión "Framework V2 Fix" */
        body { user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
        .checkerboard-bg { background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; background-color: #e5e5e5; }
        .solid-bg { background-image: none !important; }
        .tool-btn.active-tool { background-color: #d1d5db; box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.1); }
        .tool-btn.active-hole-remover { background-color: #fde047 !important; color: #713f12 !important; box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.1); border-color: #ca8a04; }
        .tool-btn.active-color-picker { background-color: #a5b4fc !important; color: #3730a3 !important; box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.1); border-color: #6366f1; }
        .brush-shape.active-shape { border-color: #3b82f6; border-width: 2px; }
        #canvas-outer-container { width: 100%; height: 100%; overflow: hidden; position: relative; cursor: default; transition: background-color 0.3s ease; }
        #canvas-inner-container { position: absolute; top: 0; left: 0; transform-origin: 0 0; }
        #image-canvas, #preview-canvas { display: block; position: absolute; top: 0; left: 0; max-width: none; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; }
        #preview-canvas { pointer-events: none; z-index: 1;} #image-canvas { z-index: 0; }
        main { height: calc(100vh - 64px - 32px); }
        .fa-line-eraser::before { content: "\f12d"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 1; } .fa-line-eraser::after { content: ""; position: absolute; left: 15%; top: 50%; width: 70%; height: 2px; background-color: currentColor; transform: translateY(-50%) rotate(0deg); opacity: 0.6; z-index: 0; } .tool-btn .fa-line-eraser { position: relative; display: inline-block; width: 1.1em; height: 1em; vertical-align: middle; } #eraser-line-tool i { font-size: 0.9em; } .fa-continuous-eraser-line { position: relative; display: inline-block; width: 1.1em; height: 1em; vertical-align: middle; } .fa-continuous-eraser-line::before { content: "\f55b"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; left: 45%; top: 45%; transform: translate(-50%, -50%) scale(0.8); z-index: 1; } .fa-continuous-eraser-line::after { content: "\f12d"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; left: 70%; top: 70%; transform: translate(-50%, -50%) scale(0.5); z-index: 2; color: #ef4444; } #continuous-eraser-line-tool i { font-size: 1em; } .fa-continuous-keep-line { position: relative; display: inline-block; width: 1.1em; height: 1em; vertical-align: middle; } .fa-continuous-keep-line::before { content: "\f55b"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; left: 45%; top: 45%; transform: translate(-50%, -50%) scale(0.8); z-index: 1; } .fa-continuous-keep-line::after { content: "\f55d"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; left: 70%; top: 70%; transform: translate(-50%, -50%) scale(0.5); z-index: 2; color: #22c55e; } #continuous-keep-line-tool i { font-size: 1em; }
        .btn-feedback { transition: background-color 0.2s ease-out, color 0.2s ease-out, border-color 0.2s ease-out; } .btn-feedback.success { background-color: #22c55e !important; color: white !important; border-color: #16a34a !important; } .btn-feedback.error { background-color: #ef4444 !important; color: white !important; border-color: #dc2626 !important; } .btn-feedback.working { background-color: #eab308 !important; color: white !important; border-color: #ca8a04 !important; cursor: wait; } .btn-feedback.cancelling { background-color: #f97316 !important; color: white !important; border-color: #ea580c !important; cursor: default; }
        .processing-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 100; pointer-events: none; } .processing-overlay i { margin-bottom: 10px; } .processing-overlay p { margin-top: 0px; font-size: 1.1rem; }
        .color-tag { display: inline-flex; align-items: center; background-color: #e5e7eb; border-radius: 9999px; padding: 2px 8px; margin: 2px; font-size: 0.8rem; line-height: 1; } .color-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; border: 1px solid #9ca3af; display: inline-block; } .remove-color-btn { margin-left: 4px; cursor: pointer; color: #ef4444; background: none; border: none; padding: 0; font-weight: bold; line-height: 1; } .remove-color-btn:hover { color: #dc2626; } #selected-colors-list { max-height: 80px; overflow-y: auto; background-color: #f9fafb; padding: 4px; border-radius: 4px; border: 1px solid #d1d5db; }
        /* Estilos Popup Comparación */
        #compare-popup-overlay { backdrop-filter: blur(3px); }
        #compare-popup-content img-comparison-slider { max-width: 100%; max-height: 100%; min-height: 200px; outline: none; border-radius: 0.25rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); }
        img-comparison-slider::part(handle) { color: #3b82f6; } /* Azul para el handle */
        img-comparison-slider::part(divider) { background-color: #3b82f6; } /* Azul para la línea divisoria */
        .compare-handle-icon { width: 100%; height: 100%; } /* Ajusta el tamaño del icono SVG si es necesario */
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen overflow-hidden">

    <header class="bg-white shadow-md p-4 flex-shrink-0 flex items-center">
        <a href="https://xocostudio.com/" target="_blank" rel="noopener noreferrer" class="mr-4 flex-shrink-0"><img src="https://xocostudio.com/assets/images/xocostudio-354x128.png" alt="XocoStudio Logo" class="h-8"></a>
        <h1 class="text-xl md:text-2xl font-bold text-gray-800">Eliminador de Fondos</h1>
    </header>

    <main class="flex-grow flex flex-col md:flex-row p-4 gap-4">
         <!-- Panel de Controles -->
        <aside class="w-full md:w-72 bg-white p-4 rounded-lg shadow space-y-6 flex-shrink-0 overflow-y-auto">
             <!-- Carga -->
             <div id="upload-section">
                 <h2 class="text-lg font-semibold mb-2">1. Cargar Imagen</h2>
                 <div id="drop-zone" class="border-2 border-dashed border-gray-400 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors">
                    <p>Arrastra y suelta</p>
                    <p class="text-sm text-gray-500 my-2">o</p>
                    <div class="flex flex-col items-center space-y-2">
                        <input type="file" id="file-input" accept="image/*" class="hidden">
                        <button id="upload-btn" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded btn-feedback"><i class="fas fa-upload mr-1"></i> Seleccionar</button>
                        <button id="paste-btn" class="w-full bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded btn-feedback disabled:opacity-50" title="Pegar (Ctrl+V)"><i class="fas fa-paste mr-1"></i> Pegar</button>
                    </div>
                    <p id="paste-support-warning" class="text-xs text-red-600 mt-2 hidden">Pegar no soportado.</p>
                 </div>
                 <p id="filename-display" class="text-xs text-gray-600 mt-2 truncate"></p>
             </div>
             <!-- Herramientas -->
             <div id="tools-section" class="space-y-4 hidden pt-4 border-t">
                 <h2 class="text-lg font-semibold mb-2">2. Herramientas</h2>
                 <!-- Auto / Color -->
                 <div class="mb-4 space-y-2">
                     <button id="remove-edge-bg-btn" class="w-full bg-cyan-600 hover:bg-cyan-800 text-white font-bold py-2 px-4 rounded btn-feedback disabled:opacity-50" title="Fondo Automático Bordes"><i class="fas fa-wand-magic-sparkles mr-1"></i> Auto (Bordes)</button>
                     <button id="remove-inner-hole-btn" class="tool-btn w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded btn-feedback disabled:opacity-50" title="Eliminar Hueco Interno (Clic)"><i class="fas fa-highlighter mr-1"></i> Hueco (Clic)</button>
                     <button id="apply-color-removal-btn" class="w-full bg-indigo-600 hover:bg-indigo-800 text-white font-bold py-2 px-4 rounded btn-feedback disabled:opacity-50" title="Aplicar Eliminación por Color"><i class="fas fa-fill-drip mr-1"></i> Aplicar Color</button>
                     <div class="mt-2">
                         <label for="edge-color-tolerance" class="block text-sm font-medium text-gray-700">Tolerancia (<span id="edge-color-tolerance-value">30</span>):</label>
                         <input type="range" id="edge-color-tolerance" min="1" max="150" value="30" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer disabled:opacity-50" disabled>
                         <p class="text-xs text-gray-500 mt-1">Sensibilidad Auto/Hueco/Color.</p>
                     </div>
                 </div>
                 <!-- Manual -->
                 <div class="border-t pt-4">
                     <p class="text-sm font-medium text-gray-700 mb-2">Ajuste manual:</p>
                     <div class="flex space-x-1 flex-wrap gap-y-1">
                         <button id="color-picker-tool" class="tool-btn p-2 rounded hover:bg-gray-200 disabled:opacity-50" title="Seleccionar Color (P)" disabled><i class="fas fa-eye-dropper fa-fw"></i></button>
                         <button id="brush-tool" class="tool-btn p-2 rounded hover:bg-gray-200 disabled:opacity-50" title="Pincel Conservar (B)" disabled><i class="fas fa-paint-brush fa-fw"></i></button>
                         <button id="eraser-tool" class="tool-btn p-2 rounded hover:bg-gray-200 disabled:opacity-50" title="Borrador Eliminar (E)" disabled><i class="fas fa-eraser fa-fw"></i></button>
                         <button id="line-tool" class="tool-btn p-2 rounded hover:bg-gray-200 disabled:opacity-50" title="Línea Conservar (L)" disabled><i class="fas fa-minus fa-fw"></i></button>
                         <button id="eraser-line-tool" class="tool-btn p-2 rounded hover:bg-gray-200 disabled:opacity-50" title="Línea Borrador (Shift+L)" disabled><i class="fa-line-eraser"></i></button>
                         <button id="continuous-keep-line-tool" class="tool-btn p-2 rounded hover:bg-gray-200 disabled:opacity-50" title="Trazo Conservar (C/W)" disabled><i class="fa-continuous-keep-line"></i></button>
                         <button id="continuous-eraser-line-tool" class="tool-btn p-2 rounded hover:bg-gray-200 disabled:opacity-50" title="Trazo Borrar (X/Q)" disabled><i class="fa-continuous-eraser-line"></i></button>
                     </div>
                 </div>
                 <!-- Colores Seleccionados -->
                 <div id="selected-colors-section" class="space-y-2 hidden pt-4 border-t">
                     <label class="block text-sm font-medium text-gray-700">Colores Seleccionados:</label>
                     <div id="selected-colors-list" class="text-xs text-gray-600">
                         <p id="no-colors-selected" class="italic text-center p-2">Ningún color. Usa <i class="fas fa-eye-dropper fa-fw"></i></p>
                     </div>
                 </div>
                 <!-- Opciones Herramienta -->
                 <div id="brush-options-section" class="space-y-3 pt-4 border-t">
                     <p class="text-sm font-medium text-gray-700 mb-2">Opciones:</p>
                     <div><label for="brush-size">Tamaño: <span id="brush-size-value">50</span>px</label><input type="range" id="brush-size" min="1" max="150" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer disabled:opacity-50" disabled></div>
                     <div id="feather-option"><label for="brush-feather">Difuminado: <span id="brush-feather-value">0.10</span></label><input type="range" id="brush-feather" min="0" max="1" step="0.05" value="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer disabled:opacity-50" title="Suavizado pincel/borrador/color" disabled></div>
                     <div><label for="brush-opacity">Opacidad: <span id="brush-opacity-value">1.00</span></label><input type="range" id="brush-opacity" min="0.05" max="1" step="0.05" value="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer disabled:opacity-50" disabled></div>
                     <div id="shape-option"><label>Forma:</label><div class="flex space-x-2 mt-1"><button id="brush-shape-circle" class="brush-shape p-1 border rounded-full w-6 h-6 bg-gray-700 disabled:opacity-50" title="Circular" disabled></button><button id="brush-shape-square" class="brush-shape p-1 border rounded w-6 h-6 bg-gray-700 disabled:opacity-50" title="Cuadrado" disabled></button></div></div>
                 </div>
                 <!-- Acciones Edición -->
                 <div class="flex space-x-2 pt-4 border-t">
                     <button id="undo-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded text-sm disabled:opacity-50" title="Deshacer (Ctrl+Z)" disabled><i class="fas fa-undo"></i> (<span id="undo-count">0</span>)</button>
                     <button id="reset-btn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm disabled:opacity-50" title="Resetear Máscara" disabled><i class="fas fa-trash-alt"></i> Reset</button>
                 </div>
             </div>
             <!-- Fondo Preview -->
              <div id="preview-bg-section" class="hidden pt-4 border-t space-y-2">
                 <h2 class="text-lg font-semibold mb-2">Fondo Preview</h2>
                 <div class="flex items-center space-x-2">
                     <button id="preview-bg-toggle-btn" class="p-2 rounded hover:bg-gray-200 disabled:opacity-50" title="Cambiar fondo" disabled><i id="preview-bg-icon" class="fas fa-th fa-fw"></i></button>
                     <input type="color" id="preview-bg-color-input" value="#FFFFFF" class="h-8 w-10 border border-gray-300 rounded disabled:opacity-50" title="Color fondo sólido" disabled>
                 </div>
              </div>
             <!-- Exportar / Copiar / Comparar -->
              <div id="export-section" class="hidden pt-4 border-t space-y-2">
                 <h2 class="text-lg font-semibold mb-2">3. Guardar / Copiar</h2>
                 <button id="export-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50 btn-feedback" disabled><i class="fas fa-download mr-1"></i> Exportar PNG</button>
                 <button id="copy-btn" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50 btn-feedback" disabled><i class="fas fa-copy mr-1"></i> Copiar Imagen</button>
                 <button id="compare-btn" class="w-full bg-teal-500 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50 btn-feedback mt-2" disabled><i class="fas fa-columns mr-1"></i> Comparar</button>
                 <p id="clipboard-support-warning" class="text-xs text-red-600 text-center hidden">Copiar no soportado.</p>
              </div>
        </aside>
        <!-- Área de Trabajo -->
        <section class="flex-grow bg-gray-300 rounded-lg shadow overflow-hidden relative">
             <div id="canvas-outer-container" class="checkerboard-bg">
                 <div id="canvas-inner-container">
                     <canvas id="image-canvas" class="hidden"></canvas>
                     <canvas id="preview-canvas" class="hidden"></canvas>
                 </div>
                 <p id="canvas-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-500 pointer-events-none">Carga una imagen</p>
             </div>
             <div id="loading-spinner" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden z-50 pointer-events-none">
                 <i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i>
                 <p class="text-lg font-semibold ml-3">Cargando...</p>
             </div>
             <div id="processing-overlay" class="processing-overlay hidden">
                 <i class="fas fa-spinner fa-spin fa-3x"></i>
                 <p id="processing-status-text">Procesando...</p>
             </div>
             <div id="status-bar" class="absolute bottom-0 left-0 bg-black bg-opacity-60 text-white text-xs p-1 rounded-tr z-10 pointer-events-none">Zoom: <span id="zoom-level">100</span>% | Herramienta: <span id="current-tool-status">Ninguna</span> | Rueda=Zoom, Espacio+Arrastrar=Mover</div>
        </section>
    </main>

    <!-- Popup de Comparación (Usando Framework) -->
    <div id="compare-popup-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1000] hidden p-4">
        <div id="compare-popup-content" class="bg-gray-100 p-4 md:p-6 rounded-lg shadow-xl max-w-5xl w-full relative flex flex-col max-h-[90vh]">
            <button id="compare-popup-close" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-3xl leading-none z-10 bg-white rounded-full w-8 h-8 flex items-center justify-center shadow">×</button>
            <h3 class="text-xl md:text-2xl font-semibold mb-4 text-center text-gray-800 flex-shrink-0">Comparación Antes / Después</h3>
            <div id="compare-container-wrapper" class="relative w-full flex-grow overflow-auto flex items-center justify-center p-2 bg-gray-300 rounded">
                <!-- El slider se consulta en JS, no necesita ID -->
                <img-comparison-slider class="rendered">
                    <img id="compare-before-img" slot="first" src="" alt="Antes" />
                    <img id="compare-after-img" slot="second" src="" alt="Después" />
                     <svg slot="handle" class="compare-handle-icon" xmlns="http://www.w3.org/2000/svg" width="40" viewBox="-8 -3 16 6">
                         <path d="M -5 -2 L -7 -2 L -7 2 L -5 2 L -5 3 L 5 3 L 5 2 L 7 2 L 7 -2 L 5 -2 L 5 -3 L -5 -3 L -5 -2" fill="currentColor" />
                         <path d="M -4 -1 L -4 1 L -2 1 L -2 -1 L -4 -1 M 2 -1 L 2 1 L 4 1 L 4 -1 L 2 -1" fill="#fff"/>
                     </svg>
                </img-comparison-slider>
            </div>
            <p class="text-center text-sm text-gray-600 mt-2 flex-shrink-0">Arrastra el control deslizante</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => { // <-- Make async
            // Wait for the web component to be defined
            await customElements.whenDefined('img-comparison-slider');
            console.log("DOM Cargado - XocoStudio BG Remover (Framework V2 Fix - Completo) - img-comparison-slider definido");

            // --- DOM Elements ---
            const dropZone=document.getElementById('drop-zone'),fileInput=document.getElementById('file-input'),uploadBtn=document.getElementById('upload-btn'),pasteBtn=document.getElementById('paste-btn'),pasteSupportWarning=document.getElementById('paste-support-warning'),filenameDisplay=document.getElementById('filename-display'),canvasOuterContainer=document.getElementById('canvas-outer-container'),canvasInnerContainer=document.getElementById('canvas-inner-container'),canvas=document.getElementById('image-canvas'),previewCanvas=document.getElementById('preview-canvas'),canvasPlaceholder=document.getElementById('canvas-placeholder'),loadingSpinner=document.getElementById('loading-spinner'),toolsSection=document.getElementById('tools-section'),exportSection=document.getElementById('export-section'),colorPickerBtn=document.getElementById('color-picker-tool'),brushBtn=document.getElementById('brush-tool'),eraserBtn=document.getElementById('eraser-tool'),lineBtn=document.getElementById('line-tool'),eraserLineBtn=document.getElementById('eraser-line-tool'),continuousKeepLineBtn=document.getElementById('continuous-keep-line-tool'),continuousEraserLineBtn=document.getElementById('continuous-eraser-line-tool'),removeEdgeBgBtn=document.getElementById('remove-edge-bg-btn'),removeInnerHoleBtn=document.getElementById('remove-inner-hole-btn'),applyColorRemovalBtn=document.getElementById('apply-color-removal-btn'),brushOptionsSection=document.getElementById('brush-options-section'),featherOptionDiv=document.getElementById('feather-option'),shapeOptionDiv=document.getElementById('shape-option'),brushSizeSlider=document.getElementById('brush-size'),brushSizeValue=document.getElementById('brush-size-value'),brushFeatherSlider=document.getElementById('brush-feather'),brushFeatherValue=document.getElementById('brush-feather-value'),brushOpacitySlider=document.getElementById('brush-opacity'),brushOpacityValue=document.getElementById('brush-opacity-value'),shapeCircleBtn=document.getElementById('brush-shape-circle'),shapeSquareBtn=document.getElementById('brush-shape-square'),edgeColorToleranceSlider=document.getElementById('edge-color-tolerance'),edgeColorToleranceValueSpan=document.getElementById('edge-color-tolerance-value'),selectedColorsSection=document.getElementById('selected-colors-section'),selectedColorsListDiv=document.getElementById('selected-colors-list'),noColorsSelectedP=document.getElementById('no-colors-selected'),undoBtn=document.getElementById('undo-btn'),undoCountSpan=document.getElementById('undo-count'),resetBtn=document.getElementById('reset-btn'),exportBtn=document.getElementById('export-btn'),copyBtn=document.getElementById('copy-btn'),clipboardSupportWarning=document.getElementById('clipboard-support-warning'),compareBtn=document.getElementById('compare-btn'),previewBgSection=document.getElementById('preview-bg-section'),previewBgToggleBtn=document.getElementById('preview-bg-toggle-btn'),previewBgIcon=document.getElementById('preview-bg-icon'),previewBgColorInput=document.getElementById('preview-bg-color-input'),zoomLevelSpan=document.getElementById('zoom-level'),currentToolSpan=document.getElementById('current-tool-status'),processingOverlay=document.getElementById('processing-overlay'),processingStatusText=document.getElementById('processing-status-text');
            const comparePopupOverlay=document.getElementById('compare-popup-overlay'),comparePopupContent=document.getElementById('compare-popup-content'),comparePopupCloseBtn=document.getElementById('compare-popup-close'),compareBeforeImg=document.getElementById('compare-before-img'),compareAfterImg=document.getElementById('compare-after-img');

            // --- State Variables ---
            let ctx=null,previewCtx=null,maskCtx=null,originalImage=null,originalImageDataCache=null,maskCanvas=null,imageFilename='imagen',isDrawing=false,lastX=0,lastY=0,history=[],currentTool='eraser',brushOptions={size:50,feather:0.1,opacity:1.0,shape:'circle'},zoomLevel=1.0,panX=0,panY=0,isPanning=false,panStartX=0,panStartY=0,isSpacePressed=false,isDrawingLine=false,lineStartX=0,lineStartY=0,isDrawingContinuousLine=false,lastContinuousLinePoint=null,currentMousePos={x:0,y:0},isClipboardWriteSupported=!!(navigator.clipboard&&navigator.clipboard.write),isClipboardReadSupported=!!(navigator.clipboard&&navigator.clipboard.read),isFloodFilling=false,cancelFloodFillRequest=false,waitingForInnerHoleClick=false,isColorPickingActive=false,selectedBackgroundColors=[],isProcessingColorRemoval=false,previewMode='checkerboard',previewBackgroundColor='#FFFFFF',holeRemoverFeedbackTimeout=null;
            let isComparePopupOpen = false; // Estado explícito del popup
            const MAX_HISTORY = 30;

            // --- Performance Throttling ---
            let lastRenderTime = 0; const RENDER_THROTTLE = 16;

            // --- Verification ---
            if (!canvas || !previewCanvas || !dropZone || !fileInput || !uploadBtn || !pasteBtn || !removeEdgeBgBtn || !removeInnerHoleBtn || !continuousKeepLineBtn || !continuousEraserLineBtn || !canvasOuterContainer || !canvasInnerContainer || !previewBgSection || !previewBgToggleBtn || !previewBgIcon || !previewBgColorInput || !toolsSection || !exportSection || !colorPickerBtn || !applyColorRemovalBtn || !selectedColorsSection || !selectedColorsListDiv || !compareBtn || !comparePopupOverlay || !comparePopupCloseBtn || !compareBeforeImg || !compareAfterImg ) { console.error("ERROR CRÍTICO: Falta elemento DOM."); alert("Error: No se pudo iniciar."); return; }
            console.log("Elementos DOM OK.");

            // --- Initialization ---
            setActiveTool('eraser'); updateToolOptionsDisplay(); setupImageLoadingListeners(); setupInteractionListeners(); setupToolControlListeners(); setupPreviewBackgroundListeners(); checkClipboardSupport(); updatePreviewBackground(); setupComparePopupListeners(); updateActionButtonsState(); updateSelectedColorsUI(); console.log("Inicialización completada.");

            // --- Helper Functions ---
            function cancelContinuousLineDrawing(silent=false){if(isDrawingContinuousLine){if(!silent)console.log("Cancelando trazo continuo.");isDrawingContinuousLine=false;lastContinuousLinePoint=null;clearPreviewCanvas();updateStatusBar();canvasOuterContainer.style.cursor=getToolCursor();updateActionButtonsState();if(!isColorPickingActive)drawToolPreview(currentMousePos.x,currentMousePos.y);return true;}return false;}
            function cancelCurrentAction(silent=false){let c=false;if(isColorPickingActive){if(!silent)console.log("Picker cancelado.");isColorPickingActive=false;canvasOuterContainer.style.cursor=getToolCursor();updateSelectedColorsUI();updateActionButtonsState();c=true;}if(waitingForInnerHoleClick){cancelInnerHoleClickMode(silent);if(!silent)console.log("Hole cancelado.");c=true;}if(isDrawingLine){isDrawingLine=false;clearPreviewCanvas();updateActionButtonsState();canvasOuterContainer.style.cursor=getToolCursor();if(!silent)console.log("Línea cancelada.");c=true;}if(cancelContinuousLineDrawing(silent))c=true;if(isDrawing){isDrawing=false;updateActionButtonsState();if(!silent)console.log("Dibujo cancelado.");c=true;canvasOuterContainer.style.cursor=getToolCursor();}if(c&&!silent&&!isColorPickingActive)drawToolPreview(currentMousePos.x,currentMousePos.y);return c;}
            function simulateEscapeKeyPressLogic(){
                if (isComparePopupOpen) return false; // Esc manejado en handleKeyDown para popup
                let c=false;
                if(waitingForInnerHoleClick){cancelInnerHoleClickMode();console.log("Modo Hueco cancelado (Esc).");c=true;}
                else if(isDrawingLine){isDrawingLine=false;clearPreviewCanvas();updateActionButtonsState();canvasOuterContainer.style.cursor=getToolCursor();console.log("Línea cancelada (Esc).");c=true;}
                else if(cancelContinuousLineDrawing(true)){console.log("Trazo continuo cancelado (Esc).");c=true;}
                else if(isColorPickingActive){cancelCurrentAction(true);console.log("Picker cancelado (Esc).");c=true;}
                else if(isDrawing){cancelCurrentAction(true);console.log("Dibujo cancelado (Esc).");c=true;}
                if(c&&!isColorPickingActive)drawToolPreview(currentMousePos.x,currentMousePos.y);
                return c;
            }
            function isIdle(){
                return !isDrawing && !isDrawingLine && !isDrawingContinuousLine &&
                       !waitingForInnerHoleClick && !isColorPickingActive &&
                       !isFloodFilling && !isProcessingColorRemoval && !isPanning &&
                       !isComparePopupOpen; // Incluye estado del popup
            }

            // --- Setup Functions ---
            function setupImageLoadingListeners(){console.log("Config listeners carga...");dropZone.addEventListener('dragover',(e)=>{e.preventDefault();dropZone.classList.add('border-blue-500','bg-blue-50');});dropZone.addEventListener('dragleave',(e)=>{e.preventDefault();dropZone.classList.remove('border-blue-500','bg-blue-50');});dropZone.addEventListener('drop',(e)=>{e.preventDefault();dropZone.classList.remove('border-blue-500','bg-blue-50');const f=e.dataTransfer?.files?.[0];if(f?.type.startsWith('image/'))handleFile(f);else if(f)alert('Suelta imagen válida.');});uploadBtn.addEventListener('click',()=>fileInput.click());pasteBtn.addEventListener('click',handlePasteButtonClick);fileInput.addEventListener('change',(e)=>{const f=e.target.files?.[0];if(f?.type.startsWith('image/')){handleFile(f);e.target.value=null;}else if(f)alert('Selecciona imagen válida.');});window.addEventListener('paste',(e)=>{const a=document.activeElement;if(isComparePopupOpen || a.tagName==='INPUT'||a.tagName==='TEXTAREA'||a.isContentEditable)return;if(handleClipboardPaste(e.clipboardData))e.preventDefault();});console.log("Listeners carga añadidos.");}
            function setupInteractionListeners(){window.addEventListener('keydown',handleKeyDown);window.addEventListener('keyup',handleKeyUp);canvasOuterContainer.addEventListener('mousedown',handleInteractionStart);canvasOuterContainer.addEventListener('mousemove',handleInteractionMove);window.addEventListener('mouseup',handleInteractionEnd);canvasOuterContainer.addEventListener('touchstart',(e)=>handleInteractionStart(e.touches[0]),{passive:false});canvasOuterContainer.addEventListener('touchmove',(e)=>handleInteractionMove(e.touches[0]),{passive:false});window.addEventListener('touchend',(e)=>handleInteractionEnd(e.changedTouches[0]));window.addEventListener('touchcancel',(e)=>handleInteractionEnd(e.changedTouches[0]));canvasOuterContainer.addEventListener('wheel',handleWheelZoom,{passive:false});canvasOuterContainer.addEventListener('mouseleave',()=>{if(!isDrawingLine&&!isDrawingContinuousLine&&!isColorPickingActive && !isComparePopupOpen)clearPreviewCanvas();});}
            function setupToolControlListeners(){console.log("Config listeners herramientas ...");colorPickerBtn.addEventListener('click',()=>setActiveTool('color-picker'));brushBtn.addEventListener('click',()=>setActiveTool('brush'));eraserBtn.addEventListener('click',()=>setActiveTool('eraser'));lineBtn.addEventListener('click',()=>setActiveTool('line'));eraserLineBtn.addEventListener('click',()=>setActiveTool('eraser-line'));continuousKeepLineBtn.addEventListener('click',()=>setActiveTool('continuous-keep-line'));continuousEraserLineBtn.addEventListener('click',()=>setActiveTool('continuous-eraser-line'));brushSizeSlider.addEventListener('input',(e)=>{if(isComparePopupOpen) return; brushOptions.size=parseInt(e.target.value);updateToolOptionsDisplay();drawToolPreview(currentMousePos.x,currentMousePos.y);});brushFeatherSlider.addEventListener('input',(e)=>{if(isComparePopupOpen) return; brushOptions.feather=parseFloat(e.target.value);updateToolOptionsDisplay();drawToolPreview(currentMousePos.x,currentMousePos.y);});brushOpacitySlider.addEventListener('input',(e)=>{if(isComparePopupOpen) return; brushOptions.opacity=parseFloat(e.target.value);updateToolOptionsDisplay();});shapeCircleBtn.addEventListener('click',()=>{if(isComparePopupOpen) return; brushOptions.shape='circle';updateToolOptionsDisplay();drawToolPreview(currentMousePos.x,currentMousePos.y);});shapeSquareBtn.addEventListener('click',()=>{if(isComparePopupOpen) return; brushOptions.shape='square';updateToolOptionsDisplay();drawToolPreview(currentMousePos.x,currentMousePos.y);});undoBtn.addEventListener('click',undo);resetBtn.addEventListener('click',()=>{if(!originalImage||history.length<=1 || isComparePopupOpen)return;if(confirm('¿Resetear ediciones?')){cancelCurrentAction(true);resetMask();selectedBackgroundColors=[];updateSelectedColorsUI();}});exportBtn.addEventListener('click',exportImage);copyBtn.addEventListener('click',copyImageToClipboard);edgeColorToleranceSlider.addEventListener('input',(e)=>{if(isComparePopupOpen) return; edgeColorToleranceValueSpan.textContent=e.target.value;});removeEdgeBgBtn.addEventListener('click',()=>{if(isComparePopupOpen) return; cancelCurrentAction(true);if(isFloodFilling){console.log("%cSolicitando cancelación...",'color:orange;font-weight:bold');cancelFloodFillRequest=true;processingStatusText.textContent="Cancelando...";showButtonFeedback(removeEdgeBgBtn,'cancelling','Cancelando...',60000);}else if(isIdle()){handleRemoveBackgroundByFloodFill();}else console.warn("Intento Auto mientras no idle.");});removeInnerHoleBtn.addEventListener('click',()=>{if(isComparePopupOpen || isFloodFilling||isProcessingColorRemoval)return;if(waitingForInnerHoleClick)cancelInnerHoleClickMode();else{cancelCurrentAction(true);if(isIdle()){activateInnerHoleClickMode();}else showButtonFeedback(removeInnerHoleBtn,'error','Ocupado',1000);}});applyColorRemovalBtn.addEventListener('click',()=>{if(isComparePopupOpen || !originalImage||selectedBackgroundColors.length===0||isFloodFilling||isProcessingColorRemoval)return;cancelCurrentAction(true);if(isIdle())applyColorRemoval();else console.warn("Intento Aplicar Color no idle.");});selectedColorsListDiv.addEventListener('click',(e)=>{if(isComparePopupOpen) return; if(e.target.classList.contains('remove-color-btn')){const r=parseInt(e.target.dataset.r,10),g=parseInt(e.target.dataset.g,10),b=parseInt(e.target.dataset.b,10);removeSelectedColor(r,g,b);}});console.log("Listeners herramientas añadidos.");}
            function setupPreviewBackgroundListeners(){console.log("Config listeners preview bg...");if(!previewBgToggleBtn||!previewBgColorInput){console.error("Faltan controles preview bg.");return;}previewBgToggleBtn.addEventListener('click',()=>{if(!originalImage || isComparePopupOpen)return;previewMode=(previewMode==='checkerboard')?'solid':'checkerboard';console.log("Modo fondo:",previewMode);updatePreviewBackground();});previewBgColorInput.addEventListener('input',(e)=>{if(isComparePopupOpen) return; previewBackgroundColor=e.target.value;if(previewMode==='solid'&&originalImage){console.log("Color fondo:",previewBackgroundColor);updatePreviewBackground();}});console.log("Listeners preview bg añadidos.");}
            function setupComparePopupListeners(){console.log("Config listeners popup compare...");if(!compareBtn||!comparePopupOverlay||!comparePopupCloseBtn){console.error("Faltan elementos popup compare.");return;}compareBtn.addEventListener('click',openComparePopup);comparePopupCloseBtn.addEventListener('click',closeComparePopup);comparePopupOverlay.addEventListener('click',(e)=>{if(e.target===comparePopupOverlay)closeComparePopup();});console.log("Listeners popup compare añadidos.");}


            // --- Core Logic ---
            function handleFile(file){console.log('>>> handleFile:',file?.name);cancelCurrentAction();if(!file?.type?.startsWith('image/')){alert('Archivo no válido.');console.error('Tipo inválido:',file?.type);return;}const reader=new FileReader();reader.onloadstart=()=>{console.log('   onloadstart');showLoadingState(file.name);};reader.onload=(e)=>{console.log('   onload');if(!e.target?.result){handleLoadingError(file.name,'Error leer archivo.');return;}originalImage=new Image();originalImage.onload=()=>{console.log(`  onload OK: ${originalImage.naturalWidth}x${originalImage.naturalHeight}`);if(originalImage.naturalWidth===0||originalImage.naturalHeight===0){handleLoadingError(file.name,'Dimensiones 0x0.');originalImage=null;return;}initializeEditor(file.name,originalImage);};originalImage.onerror=(err)=>{console.error('onerror:',err);handleLoadingError(file.name,'Error decodificar imagen.');originalImage=null;};originalImage.src=e.target.result;};reader.onerror=(err)=>{console.error('reader.onerror:',err);handleLoadingError(file.name,'Error lectura.');};try{reader.readAsDataURL(file);}catch(error){console.error("Error readAsDataURL:",error);handleLoadingError(file.name,'Error iniciar lectura.');}}
            function showLoadingState(fileName){console.log("Loading state:",fileName);cancelCurrentAction();loadingSpinner.classList.remove('hidden');canvasPlaceholder.classList.add('hidden');filenameDisplay.textContent=`Cargando: ${fileName}...`;toolsSection.classList.add('hidden');previewBgSection.classList.add('hidden');exportSection.classList.add('hidden');canvas.classList.add('hidden');previewCanvas.classList.add('hidden');originalImage=null;originalImageDataCache=null;ctx=previewCtx=maskCtx=null;history=[];selectedBackgroundColors=[];updateSelectedColorsUI();updateActionButtonsState();}
            function handleLoadingError(fileName,message){console.error(`Error cargando ${fileName||'img'}: ${message}`);cancelCurrentAction();alert(`Error cargar "${fileName||'img'}":\n${message}`);loadingSpinner.classList.add('hidden');canvasPlaceholder.classList.remove('hidden');filenameDisplay.textContent=`Error carga`;toolsSection.classList.add('hidden');previewBgSection.classList.add('hidden');exportSection.classList.add('hidden');originalImage=null;originalImageDataCache=null;ctx=previewCtx=maskCtx=null;history=[];selectedBackgroundColors=[];updateSelectedColorsUI();updateActionButtonsState();}
            function initializeEditor(fileName,loadedImage){console.log(">>> initializeEditor:",fileName);cancelCurrentAction();if(!loadedImage||!loadedImage.naturalWidth||!loadedImage.naturalHeight){handleLoadingError(fileName,"Datos imagen inválidos.");return;}imageFilename=fileName.replace(/\.[^/.]+$/,"")||'imagen_editada';filenameDisplay.textContent=`Editando: ${fileName} (${loadedImage.naturalWidth}x${loadedImage.naturalHeight})`;try{ctx=canvas.getContext('2d',{willReadFrequently:false});previewCtx=previewCanvas.getContext('2d',{willReadFrequently:true});if(!ctx||!previewCtx)throw new Error("Contextos principales null.");console.log("   Contextos OK.");}catch(e){console.error("ERROR FATAL contextos:",e);handleLoadingError(fileName,"Error interno contexto.");return;}if(!setupCanvases(loadedImage)){handleLoadingError(fileName,"Error configurando lienzos.");return;}cacheOriginalImageData();resetMask();selectedBackgroundColors=[];updateSelectedColorsUI();centerAndFitImage();requestRender();toolsSection.classList.remove('hidden');previewBgSection.classList.remove('hidden');exportSection.classList.remove('hidden');canvas.classList.remove('hidden');previewCanvas.classList.remove('hidden');loadingSpinner.classList.add('hidden');canvasPlaceholder.classList.add('hidden');setActiveTool('eraser');updatePreviewBackground();updateActionButtonsState();console.log("<<< initializeEditor completado.");}
            function setupCanvases(img){console.log(">>> setupCanvases");if(!img?.naturalWidth||!img?.naturalHeight||!canvas||!previewCanvas||!canvasInnerContainer)return false;const w=img.naturalWidth,h=img.naturalHeight;canvas.width=w;canvas.height=h;previewCanvas.width=w;previewCanvas.height=h;canvasInnerContainer.style.width=`${w}px`;canvasInnerContainer.style.height=`${h}px`;try{maskCanvas=document.createElement('canvas');maskCanvas.width=w;maskCanvas.height=h;maskCtx=maskCanvas.getContext('2d',{willReadFrequently:true});if(!maskCtx)throw new Error("maskCtx null.");console.log("   maskCtx creado.");}catch(e){alert("Error fatal: No se pudo crear máscara.");console.error("Error creando maskCtx:",e);maskCanvas=maskCtx=null;return false;}console.log(`   Canvases ${w}x${h}`);return true;}
            function cacheOriginalImageData(){if(!originalImage||!canvas||!maskCanvas){originalImageDataCache=null;console.warn("No se pudo cachear ImageData.");return;}console.log("Cacheando ImageData...");const tempC=document.createElement('canvas');tempC.width=originalImage.naturalWidth;tempC.height=originalImage.naturalHeight;const tempCtx=tempC.getContext('2d',{willReadFrequently:true});if(!tempCtx){console.error("Error ctx temporal cache.");originalImageDataCache=null;return;}try{tempCtx.drawImage(originalImage,0,0);originalImageDataCache=tempCtx.getImageData(0,0,tempC.width,tempC.height);console.log("   ImageData cacheada OK.");}catch(e){console.error("Error getImageData cache (¿CORS?):",e);alert("Advertencia: No se pudo acceder a píxeles originales (¿CORS?). Herramientas auto/color pueden fallar.");originalImageDataCache=null;}}
            function centerAndFitImage(){if(!originalImage||!canvasOuterContainer)return;const imgW=originalImage.naturalWidth,imgH=originalImage.naturalHeight;const contW=canvasOuterContainer.clientWidth,contH=canvasOuterContainer.clientHeight;zoomLevel=Math.min(1,Math.min(contW/imgW,contH/imgH)*0.95);panX=(contW-imgW*zoomLevel)/2;panY=(contH-imgH*zoomLevel)/2;updateTransform();updateStatusBar();}
            function resetMask(){if(!maskCtx||!maskCanvas||!originalImage)return;console.log("Reseteando máscara.");maskCtx.fillStyle='white';maskCtx.fillRect(0,0,maskCanvas.width,maskCanvas.height);history=[];saveStateToHistory();updateActionButtonsState();requestRender();}

            // --- Rendering & Previews ---
            function requestRender(){const n=performance.now();if(n-lastRenderTime>=RENDER_THROTTLE){renderCanvas();lastRenderTime=n;}}
            function renderCanvas(){if(!ctx||!originalImage||!maskCanvas)return;ctx.clearRect(0,0,canvas.width,canvas.height);ctx.globalCompositeOperation='source-over';ctx.drawImage(originalImage,0,0);ctx.globalCompositeOperation='destination-in';ctx.drawImage(maskCanvas,0,0);ctx.globalCompositeOperation='source-over';}
            function clearPreviewCanvas(){if(previewCtx)previewCtx.clearRect(0,0,previewCanvas.width,previewCanvas.height);}
            function drawToolPreview(ix,iy){clearPreviewCanvas();if(!previewCtx||!originalImage||isPanning||isFloodFilling||isProcessingColorRemoval||isColorPickingActive||waitingForInnerHoleClick || isComparePopupOpen)return; // Incluye chequeo popup
            if(currentTool==='brush'||currentTool==='eraser')drawBrushPreview(ix,iy);else if(isDrawingLine&&(currentTool==='line'||currentTool==='eraser-line')){drawSimpleLineMarker(lineStartX,lineStartY);drawSimpleLinePreview(lineStartX,lineStartY,ix,iy);}else if(isDrawingContinuousLine&&(currentTool==='continuous-keep-line'||currentTool==='continuous-eraser-line')){if(lastContinuousLinePoint){drawContinuousLineMarker(lastContinuousLinePoint.x,lastContinuousLinePoint.y);drawContinuousLinePreview(lastContinuousLinePoint.x,lastContinuousLinePoint.y,ix,iy);}}else if(['line','eraser-line','continuous-keep-line','continuous-eraser-line'].includes(currentTool))drawCrosshairPreview(ix,iy);}
            function drawBrushPreview(ix,iy){if(!previewCtx||!originalImage)return;const s=brushOptions.size,f=s*brushOptions.feather,sr=Math.max(0,s/2-f/2),tr=s/2;previewCtx.save();previewCtx.globalAlpha=0.6;const pc=(currentTool==='eraser')?'rgba(255,0,0,0.7)':'rgba(0,0,0,0.7)',oc='rgba(255,255,255,0.9)';if(brushOptions.shape==='circle'){const g=previewCtx.createRadialGradient(ix,iy,sr,ix,iy,tr);g.addColorStop(0,pc);g.addColorStop(1,'rgba(0,0,0,0)');previewCtx.fillStyle=g;previewCtx.beginPath();previewCtx.arc(ix,iy,tr,0,Math.PI*2);previewCtx.fill();previewCtx.strokeStyle=oc;previewCtx.lineWidth=1/zoomLevel;previewCtx.stroke();}else{const hs=s/2;previewCtx.fillStyle=pc;previewCtx.fillRect(ix-hs,iy-hs,s,s);previewCtx.strokeStyle=oc;previewCtx.lineWidth=1/zoomLevel;previewCtx.strokeRect(ix-hs,iy-hs,s,s);}previewCtx.restore();}
            function drawSimpleLineMarker(ix,iy){if(!previewCtx)return;const k=currentTool==='line';previewCtx.fillStyle=k?'rgba(0,255,0,0.7)':'rgba(255,0,0,0.7)';previewCtx.beginPath();previewCtx.arc(ix,iy,5/zoomLevel,0,Math.PI*2);previewCtx.fill();}
            function drawSimpleLinePreview(sx,sy,ex,ey){if(!previewCtx)return;const k=currentTool==='line';previewCtx.save();previewCtx.beginPath();previewCtx.moveTo(sx,sy);previewCtx.lineTo(ex,ey);previewCtx.strokeStyle=k?'rgba(0,255,0,0.5)':'rgba(255,0,0,0.5)';previewCtx.lineWidth=brushOptions.size;previewCtx.lineCap='round';previewCtx.stroke();previewCtx.restore();}
            function drawContinuousLineMarker(ix,iy){if(!previewCtx)return;const k=currentTool==='continuous-keep-line';previewCtx.fillStyle=k?'rgba(0,255,0,0.8)':'rgba(255,0,0,0.8)';previewCtx.beginPath();previewCtx.arc(ix,iy,4/zoomLevel,0,Math.PI*2);previewCtx.fill();}
            function drawContinuousLinePreview(sx,sy,ex,ey){if(!previewCtx)return;const k=currentTool==='continuous-keep-line';previewCtx.save();previewCtx.beginPath();previewCtx.moveTo(sx,sy);previewCtx.lineTo(ex,ey);previewCtx.strokeStyle=k?'rgba(0,255,0,0.5)':'rgba(255,0,0,0.5)';previewCtx.lineWidth=brushOptions.size;previewCtx.lineCap='round';previewCtx.stroke();previewCtx.restore();}
            function drawCrosshairPreview(ix,iy){if(!previewCtx)return;const cs=10/zoomLevel;previewCtx.save();previewCtx.strokeStyle='rgba(0,0,0,0.6)';previewCtx.lineWidth=1/zoomLevel;previewCtx.beginPath();previewCtx.moveTo(ix-cs,iy);previewCtx.lineTo(ix+cs,iy);previewCtx.moveTo(ix,iy-cs);previewCtx.lineTo(ix,iy+cs);previewCtx.stroke();previewCtx.restore();}

            // --- Mask Modification ---
            function applyMaskModification(dx,dy,t,o){if(!maskCtx||(t!=='brush'&&t!=='eraser'))return;const ie=t==='eraser';maskCtx.save();maskCtx.globalCompositeOperation=ie?'destination-out':'source-over';const s=o.size,hs=s/2,f=o.feather,op=o.opacity,c=ie?'0,0,0':'255,255,255';if(o.shape==='circle'){const sr=Math.max(0,hs*(1-f)),g=maskCtx.createRadialGradient(dx,dy,sr,dx,dy,hs);g.addColorStop(0,`rgba(${c}, ${op})`);g.addColorStop(1,`rgba(${c}, 0)`);maskCtx.fillStyle=g;maskCtx.beginPath();maskCtx.arc(dx,dy,hs,0,Math.PI*2);maskCtx.fill();}else{maskCtx.fillStyle=`rgba(${c}, ${op})`;maskCtx.fillRect(dx-hs,dy-hs,s,s);}maskCtx.restore();}
            function drawLineOnMask(x1,y1,x2,y2,t,o){if(!maskCtx)return;const ie=t==='eraser'||t==='eraser-line'||t==='continuous-eraser-line',s=o.size,op=o.opacity;maskCtx.save();maskCtx.globalCompositeOperation=ie?'destination-out':'source-over';maskCtx.beginPath();maskCtx.moveTo(x1,y1);maskCtx.lineTo(x2,y2);maskCtx.lineWidth=s;maskCtx.lineCap='round';maskCtx.lineJoin='round';const c=ie?`rgba(0,0,0,${op})`:`rgba(255,255,255,${op})`;maskCtx.strokeStyle=c;maskCtx.stroke();maskCtx.restore();requestRender();}

            // --- Interaction Handling ---
            function getInteractionPos(e){if(!canvasOuterContainer)return{screenX:0,screenY:0,imageX:0,imageY:0};const r=canvasOuterContainer.getBoundingClientRect(),cx=e.clientX??e.pageX??0,cy=e.clientY??e.pageY??0,sx=cx-r.left,sy=cy-r.top,ix=(sx-panX)/zoomLevel,iy=(sy-panY)/zoomLevel;return{screenX:sx,screenY:sy,imageX:ix,imageY:iy};}
            function handleInteractionStart(e){if(isComparePopupOpen || !originalImage||isFloodFilling||isProcessingColorRemoval)return; // Chequeo popup
                if(e.preventDefault&&e.cancelable)e.preventDefault();const{screenX:sx,screenY:sy,imageX:ix,imageY:iy}=getInteractionPos(e);if(isColorPickingActive){pickColorAt(ix,iy);return;}if(waitingForInnerHoleClick){removeInnerHoleAt(ix,iy);return;}if(isSpacePressed){isPanning=true;panStartX=sx-panX;panStartY=sy-panY;canvasOuterContainer.style.cursor='grabbing';return;}switch(currentTool){case'line':case'eraser-line':if(!isDrawingLine){isDrawingLine=true;lineStartX=ix;lineStartY=iy;updateActionButtonsState();drawToolPreview(ix,iy);canvasOuterContainer.style.cursor='crosshair';}else{drawLineOnMask(lineStartX,lineStartY,ix,iy,currentTool,brushOptions);saveStateToHistory();isDrawingLine=false;clearPreviewCanvas();updateActionButtonsState();canvasOuterContainer.style.cursor=getToolCursor();drawToolPreview(ix,iy);}break;case'continuous-keep-line':case'continuous-eraser-line':if(!isDrawingContinuousLine){isDrawingContinuousLine=true;lastContinuousLinePoint={x:ix,y:iy};updateActionButtonsState();drawToolPreview(ix,iy);canvasOuterContainer.style.cursor='crosshair';}else{drawLineOnMask(lastContinuousLinePoint.x,lastContinuousLinePoint.y,ix,iy,currentTool,brushOptions);lastContinuousLinePoint={x:ix,y:iy};saveStateToHistory();drawToolPreview(ix,iy);}break;case'brush':case'eraser':default:if(isDrawingLine){isDrawingLine=false;clearPreviewCanvas();updateActionButtonsState();}if(isColorPickingActive){cancelCurrentAction(true);setActiveTool('eraser');}cancelContinuousLineDrawing(true);isDrawing=true;lastX=ix;lastY=iy;updateActionButtonsState();applyMaskModification(ix,iy,currentTool,brushOptions);requestRender();canvasOuterContainer.style.cursor='none';drawToolPreview(ix,iy);break;}}
            function handleInteractionMove(e){if(isComparePopupOpen || !originalImage)return; // Chequeo popup
                const{screenX:sx,screenY:sy,imageX:ix,imageY:iy}=getInteractionPos(e);currentMousePos={x:ix,y:iy};const busy=isFloodFilling||waitingForInnerHoleClick||isColorPickingActive||isProcessingColorRemoval;if(isPanning){panX=sx-panStartX;panY=sy-panStartY;updateTransform();updateStatusBar();}else if(busy){canvasOuterContainer.style.cursor=getToolCursor();clearPreviewCanvas();}else if(isDrawing){drawLineOnMask(lastX,lastY,ix,iy,currentTool,brushOptions);lastX=ix;lastY=iy;drawToolPreview(ix,iy);canvasOuterContainer.style.cursor='none';}else{drawToolPreview(ix,iy);canvasOuterContainer.style.cursor=(currentTool==='brush'||currentTool==='eraser')?'none':getToolCursor();}}
            function handleInteractionEnd(e){if(isComparePopupOpen) return; // Chequeo popup
                if(isPanning){isPanning=false;canvasOuterContainer.style.cursor=getToolCursor();}else if(isDrawing){isDrawing=false;saveStateToHistory();updateActionButtonsState();canvasOuterContainer.style.cursor='none';drawToolPreview(currentMousePos.x,currentMousePos.y);}}
            function handleKeyDown(e){
                 // Manejo Prioritario de Escape para Popup
                 if (isComparePopupOpen) {
                     if (e.key === 'Escape') {
                         e.preventDefault();
                         closeComparePopup();
                     }
                     return; // Ignorar otras teclas si popup abierto
                 }
                 // Manejo Original (Popup cerrado)
                 const finp=document.activeElement.tagName==='INPUT'||document.activeElement.tagName==='TEXTAREA'||document.activeElement.isContentEditable;
                 if(e.key==='Escape'){const c=simulateEscapeKeyPressLogic();if(c||!finp)e.preventDefault();return;}
                 const idle=isIdle();
                 if(e.key===' '&&!isSpacePressed&&!e.repeat&&idle&&!finp){isSpacePressed=true;canvasOuterContainer.style.cursor='grab';e.preventDefault();}
                 if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='z'&&!e.repeat){if(idle){e.preventDefault();undo();}else console.log("Undo bloqueado.");}
                 if(idle&&!finp&&!e.ctrlKey&&!e.altKey&&!e.metaKey){const k=e.key.toLowerCase();if(['p','b','e','l','c','x','q','w'].includes(k))e.preventDefault();switch(k){case'p':setActiveTool('color-picker');break;case'b':setActiveTool('brush');break;case'e':setActiveTool('eraser');break;case'l':setActiveTool(e.shiftKey?'eraser-line':'line');break;case'c':case'w':setActiveTool('continuous-keep-line');break;case'x':case'q':setActiveTool('continuous-eraser-line');break;}}
            }
            function handleKeyUp(e){if(isComparePopupOpen) return; // Chequeo popup
                if(e.key===' '){isSpacePressed=false;if(!isPanning)canvasOuterContainer.style.cursor=getToolCursor();e.preventDefault();}}
            function handleWheelZoom(e){if(isComparePopupOpen || !originalImage||!isIdle())return; // Chequeo popup
                e.preventDefault();const{screenX:sx,screenY:sy}=getInteractionPos(e);const zf=e.deltaY<0?1.1:1/1.1;zoomInOut(zf,sx,sy);}
            function zoomInOut(f,px,py){if(!originalImage)return;const cz=zoomLevel,nz=Math.max(0.1,Math.min(cz*f,15));if(nz===cz)return;const dx=(px-panX)*(nz/cz-1),dy=(py-panY)*(nz/cz-1);zoomLevel=nz;panX-=dx;panY-=dy;updateTransform();updateStatusBar();clearPreviewCanvas();if(!isColorPickingActive)drawToolPreview(currentMousePos.x,currentMousePos.y);}

            // --- Tool Management ---
            function setActiveTool(tool){if(waitingForInnerHoleClick&&tool!=='hole-remover')cancelInnerHoleClickMode(true);else if(isColorPickingActive&&tool!=='color-picker')cancelCurrentAction(true);else if(tool!==currentTool)cancelCurrentAction(true);currentTool=tool;isColorPickingActive=(tool==='color-picker');console.log("Herramienta activa:",tool);const allManualButtons=[colorPickerBtn,brushBtn,eraserBtn,lineBtn,eraserLineBtn,continuousKeepLineBtn,continuousEraserLineBtn];allManualButtons.forEach(b=>b?.classList.remove('active-tool','active-color-picker'));if(!waitingForInnerHoleClick)removeInnerHoleBtn?.classList.remove('active-hole-remover');const activeBtn=document.getElementById(`${tool}-tool`);if(activeBtn&&allManualButtons.includes(activeBtn)){if(tool==='color-picker')activeBtn.classList.add('active-color-picker');else activeBtn.classList.add('active-tool');}const isBrushOrEraser=tool==='brush'||tool==='eraser';const isAnyLineBasedTool=['line','eraser-line','continuous-keep-line','continuous-eraser-line'].includes(tool);const showBrushOptionsPanel=isBrushOrEraser||isAnyLineBasedTool;if(brushOptionsSection)brushOptionsSection.style.display=showBrushOptionsPanel?'block':'none';if(featherOptionDiv)featherOptionDiv.style.display=(isBrushOrEraser||isColorPickingActive)?'block':'none';if(shapeOptionDiv)shapeOptionDiv.style.display=isBrushOrEraser?'block':'none';if(brushOpacitySlider.parentElement)brushOpacitySlider.parentElement.style.display=(isBrushOrEraser||isAnyLineBasedTool)?'block':'none';if(selectedColorsSection)selectedColorsSection.style.display=(isColorPickingActive&&originalImage)?'block':'none';canvasOuterContainer.style.cursor=getToolCursor();updateStatusBar();updateToolOptionsDisplay();updateActionButtonsState();clearPreviewCanvas();if(!isColorPickingActive&&!waitingForInnerHoleClick)drawToolPreview(currentMousePos.x,currentMousePos.y);}
            function getToolCursor(){if(isComparePopupOpen) return 'default'; // Chequeo popup
                if(isColorPickingActive)return'crosshair';if(waitingForInnerHoleClick)return'crosshair';if(isSpacePressed&&!isPanning)return'grab';if(isPanning)return'grabbing';if(currentTool==='brush'||currentTool==='eraser')return'none';if(['line','eraser-line','continuous-keep-line','continuous-eraser-line'].includes(currentTool))return'crosshair';return'default';}
            function updateToolOptionsDisplay(){if(brushSizeValue)brushSizeValue.textContent=brushOptions.size;if(brushFeatherValue)brushFeatherValue.textContent=brushOptions.feather.toFixed(2);if(brushOpacityValue)brushOpacityValue.textContent=brushOptions.opacity.toFixed(2);if(shapeCircleBtn)shapeCircleBtn.classList.toggle('active-shape',brushOptions.shape==='circle');if(shapeSquareBtn)shapeSquareBtn.classList.toggle('active-shape',brushOptions.shape==='square');}
            function updateTransform(){if(canvasInnerContainer)canvasInnerContainer.style.transform=`translate(${panX}px, ${panY}px) scale(${zoomLevel})`;}
            function updateStatusBar(){if(zoomLevelSpan)zoomLevelSpan.textContent=Math.round(zoomLevel*100);if(!currentToolSpan)return;let tn='Ninguna';
                if (isComparePopupOpen) { // Chequeo popup
                    tn = 'Comparando';
                } else if(!originalImage) {tn='Ninguna (Carga imagen)';
                } else if(waitingForInnerHoleClick) {tn='Eliminar Hueco (Clic)';
                } else if(isColorPickingActive) {tn='Seleccionar Color (P)';
                } else {
                    switch(currentTool){case'brush':tn='Pincel (B)';break;case'eraser':tn='Borrador (E)';break;case'line':tn='Línea (L)';break;case'eraser-line':tn='Línea Borrar (Shift+L)';break;case'continuous-keep-line':tn='Trazo Conservar (C/W)';break;case'continuous-eraser-line':tn='Trazo Borrar (X/Q)';break;}
                    if(isDrawingLine)tn+=' (Dibujando...)';else if(isDrawingContinuousLine)tn+=' (Trazando...)';else if(isDrawing)tn+=' (Pintando...)';else if(isPanning)tn+=' (Moviendo...)';
                }
                currentToolSpan.textContent=tn;
            }
            function updateActionButtonsState(){
                const loaded=!!originalImage&&!!ctx&&!!maskCtx;
                const canU=history.length>1;
                const idle=isIdle(); // isIdle ahora incluye !isComparePopupOpen

                // --- Estado: Popup Abierto ---
                if (isComparePopupOpen) {
                     const controlsToDisable = [ uploadBtn, pasteBtn, colorPickerBtn, brushBtn, eraserBtn, lineBtn, eraserLineBtn, continuousKeepLineBtn, continuousEraserLineBtn, removeEdgeBgBtn, removeInnerHoleBtn, applyColorRemovalBtn, brushSizeSlider, brushFeatherSlider, brushOpacitySlider, shapeCircleBtn, shapeSquareBtn, edgeColorToleranceSlider, undoBtn, resetBtn, exportBtn, copyBtn, previewBgToggleBtn, previewBgColorInput ];
                     controlsToDisable.forEach(el => { if(el) el.disabled = true; });
                     if(compareBtn) compareBtn.disabled = true; // Evita re-trigger
                     return; // Salir si popup abierto
                }

                // --- Estado: Popup Cerrado (Lógica Original + Habilitar Compare) ---
                undoBtn.disabled=!(loaded&&canU&&idle);
                undoCountSpan.textContent=Math.max(0,history.length-1);
                resetBtn.disabled=!(loaded&&canU&&idle);
                exportBtn.disabled=!(loaded&&idle);
                copyBtn.disabled=!(loaded&&isClipboardWriteSupported&&idle);
                if(compareBtn)compareBtn.disabled=!(loaded&&idle); // Habilitar Compare cuando idle
                pasteBtn.disabled=!(isClipboardReadSupported&&idle);

                const manualTools=[colorPickerBtn,brushBtn,eraserBtn,lineBtn,eraserLineBtn,continuousKeepLineBtn,continuousEraserLineBtn];
                manualTools.forEach(b=>{if(b)b.disabled=!loaded||(!idle&&!(isColorPickingActive&&b===colorPickerBtn)&&!(waitingForInnerHoleClick&&b===removeInnerHoleBtn));});
                removeInnerHoleBtn.disabled=!loaded||(!idle&&!waitingForInnerHoleClick)||isColorPickingActive||isProcessingColorRemoval||isFloodFilling;

                const disableStrictIdleOptions=!(loaded&&idle);
                const disableOptionsUnlessPicking=!(loaded&&(idle||isColorPickingActive));
                if(brushSizeSlider)brushSizeSlider.disabled=disableStrictIdleOptions;
                if(brushFeatherSlider)brushFeatherSlider.disabled=disableOptionsUnlessPicking;
                if(brushOpacitySlider)brushOpacitySlider.disabled=disableStrictIdleOptions;
                if(shapeCircleBtn)shapeCircleBtn.disabled=disableStrictIdleOptions;
                if(shapeSquareBtn)shapeSquareBtn.disabled=disableStrictIdleOptions;

                removeEdgeBgBtn.disabled=!loaded||!idle||isFloodFilling;
                edgeColorToleranceSlider.disabled=disableOptionsUnlessPicking;

                const canACR=loaded&&selectedBackgroundColors.length>0&&idle;
                if(applyColorRemovalBtn)applyColorRemovalBtn.disabled=!canACR;
                if(previewBgToggleBtn)previewBgToggleBtn.disabled=!loaded;
                if(previewBgColorInput)previewBgColorInput.disabled=!loaded||previewMode!=='solid';

                // Actualizar visuales de herramientas activas
                if(colorPickerBtn)colorPickerBtn.classList.toggle('active-color-picker',isColorPickingActive&&!colorPickerBtn.disabled);
                if(removeInnerHoleBtn)removeInnerHoleBtn.classList.toggle('active-hole-remover',waitingForInnerHoleClick&&!removeInnerHoleBtn.disabled);
                manualTools.forEach(b=>{if(b&&b!==colorPickerBtn){const isActive=b.id.startsWith(currentTool+'-tool');b.classList.toggle('active-tool',isActive&&!waitingForInnerHoleClick&&!isColorPickingActive&&!b.disabled);}});
            }


            // --- Utility Functions ---
            function showButtonFeedback(button, status, message = null, duration = 1500) {if (!button) return; const isHoleRemoverButton = button.id === 'remove-inner-hole-btn'; const isColorPickerButton = button.id === 'color-picker-tool'; const isWorkingOrCancelling = status === 'working' || status === 'cancelling'; const isJustActivatingHole = status === 'active-hole-remover'; const isJustActivatingPicker = status === 'active-color-picker'; if (!button.dataset.originalHtml && !isJustActivatingHole && !isJustActivatingPicker) button.dataset.originalHtml = button.innerHTML; if (!button.dataset.originalTitle && !isJustActivatingHole && !isJustActivatingPicker) button.dataset.originalTitle = button.title; if (button.feedbackTimeout) clearTimeout(button.feedbackTimeout); button.feedbackTimeout = null; button.classList.remove('success', 'error', 'working', 'cancelling'); if (status === 'active-hole-remover') button.classList.add('active-hole-remover'); else if (!waitingForInnerHoleClick) button.classList.remove('active-hole-remover'); if (status === 'active-color-picker') button.classList.add('active-color-picker'); else if (!isColorPickingActive) button.classList.remove('active-color-picker'); let finalMessage = message; let finalTitle = button.dataset.originalTitle || button.title; if (status === 'active-hole-remover') { finalMessage = '<i class="fas fa-hand-pointer mr-1"></i> Clic Hueco'; finalTitle = "Haz clic en un área interna..."; } else if (status === 'active-color-picker') { finalMessage = message || button.dataset.originalHtml || button.innerHTML; finalTitle = button.dataset.originalTitle || button.title; } else if (status) button.classList.add(status); if (finalMessage && button.innerHTML !== finalMessage) { if (finalMessage.startsWith('<i class="')) button.innerHTML = finalMessage; else button.textContent = finalMessage; } button.title = finalTitle; button.disabled = isWorkingOrCancelling; const shouldRevert = (status === 'success' || status === 'error'); if (shouldRevert) { const timeoutVar = isHoleRemoverButton ? 'holeRemoverFeedbackTimeout' : 'feedbackTimeout'; button[timeoutVar] = setTimeout(() => { button.classList.remove(status); if (!(isHoleRemoverButton && waitingForInnerHoleClick) && !(isColorPickerButton && isColorPickingActive)) { if (button.dataset.originalHtml) button.innerHTML = button.dataset.originalHtml; if (button.dataset.originalTitle) button.title = button.dataset.originalTitle; } else if (isHoleRemoverButton && waitingForInnerHoleClick) { button.innerHTML = '<i class="fas fa-hand-pointer mr-1"></i> Clic Hueco'; button.title = "Haz clic en un área interna..."; } updateActionButtonsState(); }, duration); } else if (!isWorkingOrCancelling && status !== 'active-hole-remover' && status !== 'active-color-picker') { updateActionButtonsState(); } }
            function updatePreviewBackground(){if(!canvasOuterContainer||!previewBgIcon||!previewBgToggleBtn)return;if(previewMode==='solid'){canvasOuterContainer.classList.remove('checkerboard-bg');canvasOuterContainer.classList.add('solid-bg');canvasOuterContainer.style.backgroundColor=previewBackgroundColor;previewBgIcon.className='fas fa-square fa-fw';previewBgToggleBtn.title='Cambiar a fondo damero';}else{canvasOuterContainer.classList.add('checkerboard-bg');canvasOuterContainer.classList.remove('solid-bg');canvasOuterContainer.style.backgroundColor='';previewBgIcon.className='fas fa-th fa-fw';previewBgToggleBtn.title='Cambiar a fondo sólido';}updateActionButtonsState();}
            function checkClipboardSupport(){if(!isClipboardReadSupported){if(pasteSupportWarning)pasteSupportWarning.classList.remove('hidden');if(pasteBtn){pasteBtn.disabled=true;pasteBtn.title="Pegar no soportado.";}console.warn("Clipboard read no soportado.");}else{if(pasteSupportWarning)pasteSupportWarning.classList.add('hidden');}if(!isClipboardWriteSupported){if(clipboardSupportWarning)clipboardSupportWarning.classList.remove('hidden');if(copyBtn){copyBtn.disabled=true;copyBtn.title="Copiar no soportado.";}console.warn("Clipboard write no soportado.");}else{if(clipboardSupportWarning)clipboardSupportWarning.classList.add('hidden');}updateActionButtonsState();}
            function saveStateToHistory(){if(!maskCtx||!maskCanvas)return;try{const c=maskCtx.getImageData(0,0,maskCanvas.width,maskCanvas.height);history.push(c);if(history.length>MAX_HISTORY+1)history.shift();console.log("Historial:",history.length);updateActionButtonsState();}catch(e){console.error("Error guardando historial:",e);}}
            function undo(){if(history.length<=1||!isIdle())return;console.log("Deshaciendo...");try{history.pop();const p=history[history.length-1];if(p)maskCtx.putImageData(p,0,0);requestRender();}catch(e){console.error("Error deshacer:",e);}finally{updateActionButtonsState();}}
            function showProcessingOverlay(m){if(processingStatusText)processingStatusText.textContent=m||"Procesando...";if(processingOverlay)processingOverlay.classList.remove('hidden');}
            function hideProcessingOverlay(){if(processingOverlay)processingOverlay.classList.add('hidden');}
            function drawCheckerboard(tCtx,w,h,s=10){tCtx.save();tCtx.fillStyle='#fff';tCtx.fillRect(0,0,w,h);tCtx.fillStyle='#ccc';for(let i=0;i<w;i+=s){for(let j=0;j<h;j+=s){if((Math.floor(i/s)+Math.floor(j/s))%2===0)tCtx.fillRect(i,j,s,s);}}tCtx.restore();}
            function colorDistance(r1,g1,b1,r2,g2,b2){const dr=r1-r2,dg=g1-g2,db=b1-b2;return dr*dr+dg*dg+db*db;}


            // --- Image Generation & Export/Copy/Paste ---
            async function createFinalImageBlob(f='image/png'){if(!originalImage||!maskCanvas)return null;console.log("Creando Blob final...");const fc=document.createElement('canvas');fc.width=originalImage.naturalWidth;fc.height=originalImage.naturalHeight;const fctx=fc.getContext('2d');if(!fctx){console.error("No ctx final.");return null;}if(previewMode==='checkerboard')drawCheckerboard(fctx,fc.width,fc.height);else if(previewMode==='solid'){fctx.fillStyle=previewBackgroundColor;fctx.fillRect(0,0,fc.width,fc.height);}else fctx.clearRect(0,0,fc.width,fc.height);fctx.drawImage(originalImage,0,0);fctx.globalCompositeOperation='destination-in';fctx.drawImage(maskCanvas,0,0);fctx.globalCompositeOperation='source-over';return new Promise(r=>fc.toBlob(r,f));}
            async function exportImage(){if(isComparePopupOpen || !originalImage||!exportBtn||exportBtn.disabled )return; // Chequeo popup
                showButtonFeedback(exportBtn,'working','Exportando...');try{const b=await createFinalImageBlob();if(!b)throw new Error("Fallo Blob.");const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`${imageFilename}_sin_fondo.png`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);showButtonFeedback(exportBtn,'success','<i class="fas fa-check"></i> Exportado');}catch(e){console.error("Error exportando:",e);alert(`Error exportar: ${e.message}`);showButtonFeedback(exportBtn,'error','<i class="fas fa-times"></i> Error');}}
            async function copyImageToClipboard(){if(isComparePopupOpen || !originalImage||!isClipboardWriteSupported||!copyBtn||copyBtn.disabled )return; // Chequeo popup
                showButtonFeedback(copyBtn,'working','Copiando...');try{const b=await createFinalImageBlob('image/png');if(!b)throw new Error("Fallo Blob.");const i=new ClipboardItem({'image/png':b});await navigator.clipboard.write([i]);showButtonFeedback(copyBtn,'success','<i class="fas fa-check"></i> Copiado');}catch(e){console.error("Error copiando:",e);let m="Error desconocido.";if(e.name==='NotAllowedError')m="Permiso denegado.";else if(e.message?.toLowerCase().includes("large"))m="Imagen grande.";else if(e.name==='SecurityError')m="Error seguridad.";alert(`No se pudo copiar: ${m}\nDetalles: ${e.message}`);showButtonFeedback(copyBtn,'error','<i class="fas fa-times"></i> Error');}}
            async function handlePasteButtonClick(){if(isComparePopupOpen || !isClipboardReadSupported||!pasteBtn||pasteBtn.disabled )return; // Chequeo popup
                console.log("Intentando pegar (botón)...");showButtonFeedback(pasteBtn,'working','Pegando...');try{const p=await navigator.permissions.query({name:'clipboard-read'});if(p.state==='denied')throw new Error("Permiso denegado.");const ci=await navigator.clipboard.read();let found=false;for(const item of ci){const it=item.types.find(t=>t.startsWith("image/"));if(it){const b=await item.getType(it);cancelCurrentAction(true);handleFile(new File([b],"img_pegada.png",{type:it}));found=true;break;}}if(found)showButtonFeedback(pasteBtn,'success','<i class="fas fa-check"></i> Pegado');else showButtonFeedback(pasteBtn,'error','No imagen',1000);}catch(e){console.error("Error pegando:",e);let m="Error.";if(e.name==='NotAllowedError'||e.message?.includes("denied"))m="Permiso denegado.";else if(e.name==='SecurityError')m="Error seguridad.";else if(e.message?.includes("No valid data"))m="No imagen.";else if(e.message?.includes("activation"))m="Requiere interacción.";alert(`No se pudo pegar: ${m}\nDetalles: ${e.message}`);showButtonFeedback(pasteBtn,'error','<i class="fas fa-times"></i> Error');}}
            function handleClipboardPaste(cd){if(isComparePopupOpen || !cd?.items)return false; // Chequeo popup
                console.log("Evento paste...");let found=false;for(const i of cd.items){if(i.kind==='file'&&i.type.startsWith('image/')){const f=i.getAsFile();if(f){cancelCurrentAction(true);handleFile(f);found=true;break;}}}if(!found)console.log("No imagen 'file' en paste.");return found;}

            // --- Compare Popup Functions (FRAMEWORK Method - Integrado con Estado) ---
            async function openComparePopup(){
                if (!originalImage || !comparePopupOverlay || !compareBeforeImg || !compareAfterImg || isComparePopupOpen) {
                    console.warn("No abrir comparación: faltan elementos o ya está abierto.");
                    return;
                }
                const slider = comparePopupOverlay.querySelector("img-comparison-slider");
                if (!slider) {
                    console.error("Error crítico: No se encontró el elemento img-comparison-slider dentro del popup.");
                    alert("Error al iniciar la comparación: componente no encontrado.");
                    return;
                }

                console.log("Abriendo popup compare...");
                isComparePopupOpen = true; // Establecer estado
                updateActionButtonsState(); // Deshabilitar controles fondo
                updateStatusBar(); // Actualizar barra estado

                document.body.style.overflow = 'hidden';
                compareBeforeImg.alt = `Antes (Cargando...)`; compareAfterImg.alt = 'Después (Cargando...)';
                showButtonFeedback(compareBtn, 'working', 'Generando...', 60000);

                try {
                    compareBeforeImg.src = originalImage.src;
                    compareBeforeImg.alt = `Antes (${originalImage.naturalWidth}×${originalImage.naturalHeight})`;

                    const blob = await createFinalImageBlob(); // Usa previewMode actual
                    if (!blob) throw new Error("Fallo blob 'Después'");

                    const dataUrl = await new Promise((res, rej) => {
                        const r = new FileReader(); r.onload = e => res(e.target.result); r.onerror = e => rej(e); r.readAsDataURL(blob);
                    });
                    compareAfterImg.src = dataUrl;
                    compareAfterImg.alt = `Después (${originalImage.naturalWidth}×${originalImage.naturalHeight})`;
                    console.log("   Imagen 'Después' cargada.");

                    slider.value = 50; // Resetear posición
                    showButtonFeedback(compareBtn, null); // Limpiar feedback botón
                    comparePopupOverlay.classList.remove('hidden'); // Mostrar popup

                } catch (err) {
                    console.error("Error generando imágenes popup:", err);
                    alert("Error al generar imagen editada para comparación.");
                    showButtonFeedback(compareBtn, 'error', 'Error', 2000);
                    closeComparePopup(true); // Forzar cierre en error
                }
            }

            function closeComparePopup(forceClose = false){
                 if (!isComparePopupOpen && !forceClose) return;

                 isComparePopupOpen = false; // Limpiar estado
                 if(comparePopupOverlay) comparePopupOverlay.classList.add('hidden');
                 document.body.style.overflow=''; // Restaurar scroll
                 if(compareBeforeImg) compareBeforeImg.src=''; // Limpiar memoria
                 if(compareAfterImg) compareAfterImg.src=''; // Limpiar memoria
                 console.log("Popup compare cerrado.");
                 updateActionButtonsState(); // Rehabilitar controles
                 updateStatusBar(); // Actualizar barra estado

                 // Restaurar botón Compare si no fue error
                 if (!forceClose && compareBtn && compareBtn.dataset.originalHtml) {
                     compareBtn.innerHTML = compareBtn.dataset.originalHtml;
                     compareBtn.title = compareBtn.dataset.originalTitle || 'Comparar';
                     compareBtn.classList.remove('success', 'error', 'working', 'cancelling');
                 }
            }


            // --- Flood Fill Logic ---
            async function handleRemoveBackgroundByFloodFill(){console.log(`%c>>> FloodFill Bordes`,'color:blue;font-weight:bold');if(!originalImage||!maskCtx||!maskCanvas||!originalImageDataCache||!isIdle()){console.warn("FloodFill abortado: Estado inválido");if(!isFloodFilling)showButtonFeedback(removeEdgeBgBtn,'error','Ocupado',1000);return;}isFloodFilling=true;cancelFloodFillRequest=false;updateActionButtonsState();showButtonFeedback(removeEdgeBgBtn,'working','Analizando...');showProcessingOverlay('Analizando bordes...');await new Promise(r=>setTimeout(r,50));try{if(cancelFloodFillRequest)throw new Error("CancelledBeforeStart");processingStatusText.textContent="Procesando fondo...";const t=parseInt(edgeColorToleranceSlider.value,10),tsq=t*t*3;const oD=originalImageDataCache,miD=maskCtx.getImageData(0,0,maskCanvas.width,maskCanvas.height),w=miD.width,h=miD.height,v=Array(h).fill(null).map(()=>Array(w).fill(false));console.log(` FloodFill Bordes. Tol:${t}, DistSq:${tsq.toFixed(0)}`);const st=performance.now();let canc=false;for(let x=0;x<w;x++){if(cancelFloodFillRequest){canc=true;break;}if(await floodFillMaskAsync(oD,miD,x,0,tsq,v)){canc=true;break;}if(await floodFillMaskAsync(oD,miD,x,h-1,tsq,v)){canc=true;break;}}if(!canc){for(let y=1;y<h-1;y++){if(cancelFloodFillRequest){canc=true;break;}if(await floodFillMaskAsync(oD,miD,0,y,tsq,v)){canc=true;break;}if(await floodFillMaskAsync(oD,miD,w-1,y,tsq,v)){canc=true;break;}}}const et=performance.now();console.log(` FloodFill terminado ${((et-st)/1000).toFixed(2)}s. Cancelado:${canc||cancelFloodFillRequest}`);if(cancelFloodFillRequest||canc)throw new Error("Cancelled");maskCtx.putImageData(miD,0,0);saveStateToHistory();renderCanvas();console.log("<<< FloodFill Completado.");showButtonFeedback(removeEdgeBgBtn,'success','<i class="fas fa-check"></i> Hecho');}catch(e){if(e.message==="Cancelled"||e.message==="CancelledBeforeStart"){console.log("%cFloodFill CANCELADO.",'color:orange;');showButtonFeedback(removeEdgeBgBtn,'error','Cancelado',1500);}else{console.error("Error FloodFill:",e);alert(`Error proceso:${e.message}`);showButtonFeedback(removeEdgeBgBtn,'error','Error',1500);}}finally{console.log(" Finally FloodFill: Limpiando.");isFloodFilling=false;cancelFloodFillRequest=false;hideProcessingOverlay();if(removeEdgeBgBtn&&!removeEdgeBgBtn.classList.contains('success')&&!removeEdgeBgBtn.classList.contains('error')){if(removeEdgeBgBtn.dataset.originalHtml)removeEdgeBgBtn.innerHTML=removeEdgeBgBtn.dataset.originalHtml;if(removeEdgeBgBtn.dataset.originalTitle)removeEdgeBgBtn.title=removeEdgeBgBtn.dataset.originalTitle;}updateActionButtonsState();}}
            async function floodFillMaskAsync(oD,mD,sx,sy,tsq,v){const w=oD.width,h=oD.height,oP=oD.data,mP=mD.data,cInt=5000;if(sx<0||sx>=w||sy<0||sy>=h||v[sy][sx])return false;const sIdx=(sy*w+sx)*4;if(mP[sIdx+3]<128||oP[sIdx+3]<128){v[sy][sx]=true;return false;}const sR=oP[sIdx],sG=oP[sIdx+1],sB=oP[sIdx+2];const q=[[sx,sy]];v[sy][sx]=true;mP[sIdx+3]=0;let pp=0;while(q.length>0){pp++;if(pp%cInt===0){if(cancelFloodFillRequest)return true;await new Promise(r=>setTimeout(r,0));if(cancelFloodFillRequest)return true;}const[x,y]=q.shift();const n=[[x,y-1],[x,y+1],[x-1,y],[x+1,y]];for(const[nx,ny]of n){if(nx>=0&&nx<w&&ny>=0&&ny<h&&!v[ny][nx]){v[ny][nx]=true;const nIdx=(ny*w+nx)*4;if(mP[nIdx+3]>=128&&oP[nIdx+3]>=128){const nR=oP[nIdx],nG=oP[nIdx+1],nB=oP[nIdx+2];if(colorDistance(sR,sG,sB,nR,nG,nB)<=tsq){q.push([nx,ny]);mP[nIdx+3]=0;}}}}}return false;}
            function activateInnerHoleClickMode() {const idle = isIdle();if (!originalImage || !idle || waitingForInnerHoleClick) {console.warn("No activar 'Eliminar Hueco': Estado inválido.");if (!idle && !waitingForInnerHoleClick) showButtonFeedback(removeInnerHoleBtn, 'error', 'Ocupado', 1000);return;}console.log("Activando modo 'Eliminar Hueco Interno'");waitingForInnerHoleClick = true;currentTool = 'hole-remover';showButtonFeedback(removeInnerHoleBtn, 'active-hole-remover');updateStatusBar();updateActionButtonsState();clearPreviewCanvas();canvasOuterContainer.style.cursor = 'crosshair';}
            function cancelInnerHoleClickMode(silent = false) {if (!waitingForInnerHoleClick) return;if (!silent) console.log("Cancelando modo 'Eliminar Hueco Interno'");waitingForInnerHoleClick = false;if (holeRemoverFeedbackTimeout) clearTimeout(holeRemoverFeedbackTimeout);holeRemoverFeedbackTimeout = null;removeInnerHoleBtn.classList.remove('active-hole-remover', 'success', 'error', 'working', 'cancelling');if (removeInnerHoleBtn.dataset.originalHtml) removeInnerHoleBtn.innerHTML = removeInnerHoleBtn.dataset.originalHtml;else removeInnerHoleBtn.innerHTML = '<i class="fas fa-highlighter mr-1"></i> Eliminar Hueco Interno';if (removeInnerHoleBtn.dataset.originalTitle) removeInnerHoleBtn.title = removeInnerHoleBtn.dataset.originalTitle;else removeInnerHoleBtn.title = "Activa/Desactiva el modo 'Eliminar Hueco'.";if (currentTool === 'hole-remover') {setActiveTool('eraser');} else {updateStatusBar();updateActionButtonsState();canvasOuterContainer.style.cursor = getToolCursor();}}
            function removeInnerHoleAt(startX, startY) {console.log(`%c>>> removeInnerHoleAt (${startX.toFixed(0)}, ${startY.toFixed(0)})`, 'color: purple; font-weight: bold;');if (!waitingForInnerHoleClick || !originalImage || !maskCtx || !maskCanvas || !originalImageDataCache || isFloodFilling || isProcessingColorRemoval ) {console.warn("Eliminar Hueco abortado: Estado inválido o no esperando clic.");if(waitingForInnerHoleClick) showButtonFeedback(removeInnerHoleBtn, 'error', 'Ocupado', 1000);return;}const width = maskCanvas.width; const height = maskCanvas.height;startX = Math.floor(startX); startY = Math.floor(startY);if (startX < 0 || startX >= width || startY < 0 || startY >= height) { console.log("Clic fuera de límites."); showButtonFeedback(removeInnerHoleBtn, 'error', 'Fuera Límites', 1000); return; }let pixelsChanged = 0; let success = false; let message = ''; let statusClass = 'error';try {const maskImageData = maskCtx.getImageData(0, 0, width, height); const maskPixels = maskImageData.data; const originalPixels = originalImageDataCache.data; const tolerance = parseInt(edgeColorToleranceSlider.value, 10); const toleranceSq = tolerance * tolerance * 3; const startIndex = (startY * width + startX) * 4;if (maskPixels[startIndex + 3] < 128) { message = 'Ya Transparente'; statusClass = 'error'; success = false; } else {const startR = originalPixels[startIndex]; const startG = originalPixels[startIndex + 1]; const startB = originalPixels[startIndex + 2]; const visited = Array(height).fill(null).map(() => Array(width).fill(false)); const queue = [[startX, startY]]; visited[startY][startX] = true; maskPixels[startIndex + 3] = 0; pixelsChanged = 1; let iterations = 0; const maxIterations = width * height * 2;while (queue.length > 0) { iterations++; if (iterations > maxIterations) { console.warn(`Flood fill (hueco) excedió límite desde (${startX}, ${startY}).`); message = 'Proceso Largo'; statusClass = 'error'; success = false; break; } const [x, y] = queue.shift(); const neighbors = [[x, y - 1], [x, y + 1], [x - 1, y], [x + 1, y]]; for (const [nx, ny] of neighbors) { if (nx >= 0 && nx < width && ny >= 0 && ny < height && !visited[ny][nx]) { visited[ny][nx] = true; const nIndex = (ny * width + nx) * 4; if (maskPixels[nIndex + 3] >= 128) { const nR_orig = originalPixels[nIndex]; const nG_orig = originalPixels[nIndex + 1]; const nB_orig = originalPixels[nIndex + 2]; if (colorDistance(startR, startG, startB, nR_orig, nG_orig, nB_orig) <= toleranceSq) { queue.push([nx, ny]); maskPixels[nIndex + 3] = 0; pixelsChanged++; } } } } }if (pixelsChanged > 0 && success !== false) { maskCtx.putImageData(maskImageData, 0, 0); saveStateToHistory(); requestRender(); message = '<i class="fas fa-check"></i> Hueco Borrado'; statusClass = 'success'; success = true; } else if (success !== false) { message = 'No Cambios'; statusClass = 'error'; success = false; }}} catch (error) { console.error("Error eliminando hueco:", error); alert(`Error: ${error.message}`); message = '<i class="fas fa-times"></i> Error Proc.'; statusClass = 'error'; success = false; } finally {showButtonFeedback(removeInnerHoleBtn, statusClass, message, success ? 1000 : 1500);updateActionButtonsState();}}


            // --- Color Picker & Removal Logic ---
            function pickColorAt(ix,iy){if(!originalImageDataCache||!originalImage){console.warn("Pick color sin datos.");return;}const x=Math.floor(ix),y=Math.floor(iy),w=originalImage.naturalWidth,h=originalImage.naturalHeight;if(x<0||x>=w||y<0||y>=h){console.log("Clic fuera color.");return;}const idx=(y*w+x)*4,r=originalImageDataCache.data[idx],g=originalImageDataCache.data[idx+1],b=originalImageDataCache.data[idx+2];const exists=selectedBackgroundColors.some(c=>c.r===r&&c.g===g&&c.b===b);if(!exists){selectedBackgroundColors.push({r,g,b});console.log(`Color add: rgb(${r},${g},${b}). Total:${selectedBackgroundColors.length}`);updateSelectedColorsUI();updateActionButtonsState();showButtonFeedback(colorPickerBtn,'success',`<i class="fas fa-plus"></i> ${r},${g},${b}`,800);}else{console.log(`Color rgb(${r},${g},${b}) ya existe.`);showButtonFeedback(colorPickerBtn,'error','Ya existe',800);}}
            function removeSelectedColor(r,g,b){selectedBackgroundColors=selectedBackgroundColors.filter(c=>!(c.r===r&&c.g===g&&c.b===b));console.log(`Color rm: rgb(${r},${g},${b}). Restan:${selectedBackgroundColors.length}`);updateSelectedColorsUI();updateActionButtonsState();}
            function updateSelectedColorsUI(){if(!selectedColorsListDiv||!noColorsSelectedP||!selectedColorsSection)return;selectedColorsListDiv.innerHTML='';if(selectedBackgroundColors.length===0){if(noColorsSelectedP){selectedColorsListDiv.appendChild(noColorsSelectedP);noColorsSelectedP.style.display='block';}}else{if(noColorsSelectedP)noColorsSelectedP.style.display='none';selectedBackgroundColors.forEach(c=>{const tag=document.createElement('span');tag.className='color-tag';const dot=document.createElement('span');dot.className='color-dot';dot.style.backgroundColor=`rgb(${c.r},${c.g},${c.b})`;const txt=document.createElement('span');txt.textContent=`${c.r},${c.g},${c.b}`;const btn=document.createElement('button');btn.className='remove-color-btn';btn.innerHTML='×';btn.title='Eliminar';btn.type='button';btn.dataset.r=c.r;btn.dataset.g=c.g;btn.dataset.b=c.b;tag.appendChild(dot);tag.appendChild(txt);tag.appendChild(btn);selectedColorsListDiv.appendChild(tag);});}selectedColorsSection.style.display=(isColorPickingActive&&originalImage)?'block':'none';}
            function applyFeatherToMask(miD,w,h,f){const r=Math.round(f*15);if(r<=0)return miD;console.log(` Suavizado r~${r}px`);const d=miD.data,ta=new Uint8Array(w*h),ba=new Uint8Array(w*h);for(let i=0;i<w*h;i++)ta[i]=d[i*4+3];for(let y=0;y<h;y++){for(let x=0;x<w;x++){let totA=0,cnt=0;for(let ky=-r;ky<=r;ky++){const ny=y+ky;if(ny<0||ny>=h)continue;for(let kx=-r;kx<=r;kx++){const nx=x+kx;if(nx<0||nx>=w)continue;totA+=ta[ny*w+nx];cnt++;}}if(cnt>0)ba[y*w+x]=totA/cnt;else ba[y*w+x]=ta[y*w+x];}}for(let i=0;i<w*h;i++)d[i*4+3]=ba[i];return miD;}
            async function applyColorRemoval(){console.log("%c>>> Aplicando Elim. Color...",'color:purple;font-weight:bold');if(!originalImage||!maskCtx||!maskCanvas||!originalImageDataCache||selectedBackgroundColors.length===0||!isIdle()){console.warn("Elim. Color abortado.");showButtonFeedback(applyColorRemovalBtn,'error','Error Estado',1000);return;}isProcessingColorRemoval=true;updateActionButtonsState();showButtonFeedback(applyColorRemovalBtn,'working','Procesando...');showProcessingOverlay('Eliminando colores...');await new Promise(r=>setTimeout(r,50));try{const t=parseInt(edgeColorToleranceSlider.value,10),tsq=t*t*3,f=parseFloat(brushFeatherSlider.value);const w=maskCanvas.width,h=maskCanvas.height,oP=originalImageDataCache.data,miD=maskCtx.getImageData(0,0,w,h),mP=miD.data;console.log(` Procesando ${w}x${h}. Col:${selectedBackgroundColors.length},Tol:${t},Suav:${f}`);const st=performance.now();for(let y=0;y<h;y++){for(let x=0;x<w;x++){const idx=(y*w+x)*4,rO=oP[idx],gO=oP[idx+1],bO=oP[idx+2],aO=oP[idx+3];if(aO<128)continue;let match=false;for(const bgC of selectedBackgroundColors){if(colorDistance(rO,gO,bO,bgC.r,bgC.g,bgC.b)<=tsq){match=true;break;}}if(match)mP[idx+3]=0;}}let fmD=miD;if(f>0)fmD=applyFeatherToMask(miD,w,h,f);maskCtx.putImageData(fmD,0,0);const et=performance.now();console.log(` Elim. Color completada ${((et-st)/1000).toFixed(2)}s.`);saveStateToHistory();renderCanvas();showButtonFeedback(applyColorRemovalBtn,'success','<i class="fas fa-check"></i> Aplicado');}catch(e){console.error("Error elim. color:",e);alert(`Error aplicar color:${e.message}`);showButtonFeedback(applyColorRemovalBtn,'error','Error',1500);}finally{console.log(" Finally Elim. Color: Limpiando.");isProcessingColorRemoval=false;hideProcessingOverlay();if(applyColorRemovalBtn&&!applyColorRemovalBtn.classList.contains('success')&&!applyColorRemovalBtn.classList.contains('error')){if(applyColorRemovalBtn.dataset.originalHtml)applyColorRemovalBtn.innerHTML=applyColorRemovalBtn.dataset.originalHtml;if(applyColorRemovalBtn.dataset.originalTitle)applyColorRemovalBtn.title=applyColorRemovalBtn.dataset.originalTitle;}updateActionButtonsState();}}


            // --- Final cierre del listener DOMContentLoaded ---
        }); // End DOMContentLoaded Listener
    </script>
</body>
</html>
